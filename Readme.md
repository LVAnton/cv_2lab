# ЛР2: Трекинг объекта на видео на основе ключевых точек

## 1. Теоретическая база

В данной работе рассматривается задача трекинга плоского объекта на видео по его крупному изображению в первом кадре. Основой подхода является использование **ключевых точек** и их дескрипторов, а также оценка **гомографии** между шаблонным изображением объекта и текущими кадрами видео.

Ключевые точки (feature points) — это характерные точки изображения (углы, контрастные текстурные элементы), которые можно устойчиво находить при изменениях масштаба, поворота и освещения. Для описания окрестности точки используются дескрипторы (вектор признаков). В работе применяется алгоритм **SIFT** (Scale-Invariant Feature Transform), обеспечивающий устойчивость к изменению масштаба и поворота объекта.

Для сопоставления ключевых точек между первым кадром (шаблоном объекта) и текущим кадром используется сопоставление дескрипторов: в простом варианте — полный перебор (Brute-Force) с нормой L2 и `crossCheck=True`, в улучшенном — KNN-сопоставление с применением критерия Lowe ratio для отбора наиболее надёжных соответствий. По найденным соответствиям оценивается матрица **гомографии**, задающая перспективное преобразование плоскости объекта из координат первого кадра в координаты текущего кадра. Применяя гомографию к прямоугольнику, соответствующему границам объекта в первом кадре, можно восстановить положение и ориентацию объекта на каждом последующем кадре.

В улучшенном варианте используется также классический метод **оптического потока Лукаса–Канаде (Lucas–Kanade optical flow)**. Оптический поток позволяет отслеживать уже найденные точки между соседними кадрами, опираясь на предположение о малых смещениях и локальной постоянстве яркости. Это снижает вычислительную нагрузку, так как нет необходимости на каждом кадре полностью переоткрывать и сопоставлять все ключевые точки на изображении.

## 2. Описание разработанной системы

Реализовано 2 скрипта на Python с использованием библиотеки OpenCV:

simple_tracking.py — базовый трекинг объекта по ключевым точкам SIFT и гомографии;
smart_tracking.py — улучшенный трекинг, совмещающий SIFT + гомографию с оптическим потоком Лукаса–Канаде и периодической реинициализацией.

### 2.1. Общая архитектура

Основные этапы работы обоих программ:
Чтение входного видео и извлечение первого кадра. Предполагается, что на первом кадре объект занимает значительную часть кадра и показан крупным планом.
Инициализация детектора признаков SIFT.
Нахождение ключевых точек и дескрипторов на первом кадре (шаблоне).
Обработка последующих кадров с отображением результатов трекинга в двух окнах:
"Трекинг объекта" / "Улучшенное отслеживание объекта" — основной кадр с отрисованной рамкой
"Соответствия ключевых точек" / "Совпадения точек" — визуализация совпадений между шаблоном и текущим кадром
Оба скрипта поддерживают интерактивный выбор видеофайла из четырёх вариантов:
mona-lisa.avi
mona-lisa-blur.avi
mona-lisa-blur-extra-credit.avi
our-video.mp4

### 2.2. Режим `simple` (SIFT + Homography)

#### Основные функции:
get_keypoints_descriptors(frame) — поиск ключевых точек и дескрипторов SIFT на изображении;
match_keypoints(desc1, desc2) — сопоставление дескрипторов методом Brute-Force с нормой L2 и crossCheck=True;
find_homography(kp1, kp2, matches) — вычисление матрицы гомографии по соответствиям ключевых точек с использованием RANSAC;
draw_tracking_box(frame, H, template_shape) — отрисовка зелёной рамки на основе гомографии.

#### Алгоритм работы:
Для каждого кадра вычисляются ключевые точки и дескрипторы SIFT.
Выполняется сопоставление дескрипторов текущего кадра с дескрипторами шаблона.
Из лучших совпадений оценивается матрица гомографии.
Прямоугольник, соответствующий границам объекта в первом кадре, переносится в координаты текущего кадра посредством гомографии.
На кадре рисуется рамка, соответствующая положению и ориентации объекта.
Дополнительно отображается окно с визуализацией совпадений ключевых точек между шаблоном и текущим кадром.

### 2.3. Режим `flow` (SIFT + Homography + Optical Flow)

#### Основные функции
get_features(frame) — нахождение ключевых точек и дескрипторов в оттенках серого;
find_good_matches(desc1, desc2) — сопоставление дескрипторов методом KNN с применением Lowe ratio test;
find_homography_from_matches(kp1, kp2, matches) — вычисление гомографии с проверкой;
init_tracking_points(gray_frame, box_corners) — инициализация точек для отслеживания оптическим потоком;
draw_matches_image() — создание изображения с совпадениями точек.

#### Алгоритм работы:
##### Инициализация по первому кадру:
первый кадр переводится в градации серого;
вычисляются SIFT-признаки;
внутри рамки объекта выбираются точки для оптического потока.
##### Отслеживание по оптическому потоку:
для каждой пары соседних кадров вычисляются новые координаты ранее выбранных точек;
по соответствиям "старые точки — новые точки" оценивается гомография между предыдущим и текущим кадром;
предыдущая рамка вокруг объекта переносится на текущий кадр.

##### Реинициализация:
если число корректно отследенных точек мало, запускается процедура переинициализации через SIFT
снова находится положение объекта и выбираются новые точки для оптического потока.

## 3. Результаты работы и тестирования системы

Алгоритм был протестирован в двух режимах:

1. **На трёх тестовых видеороликах**.
2. **На собственном видео**, где объектом является книга. В первом кадре обложка книги показана крупным планом, далее камера постепенно отдаляется и изменяет ракурс.

Наблюдения:

- В режиме `simple`:
  - при хорошем освещении и достаточном размере объекта рамка устойчиво следует за книгой;
  - при сильном отдалении и уменьшении объекта число совпадений между шаблоном и текущим кадром уменьшается, гомография становится менее надёжной, из-за чего рамка иногда исчезает или начинает колебаться;
- В режиме `flow`:
  - при плавном движении камеры по отношению к книге рамка обновляется более плавно, так как между кадрами используются смещения точек оптического потока, а не полный пересчёт признаков;
  - при кратковременных потерях устойчивости оптического потока (например, при резком движении) срабатывает механизм реинициализации, и рамка вновь “прилипает” к объекту после стабилизации кадра;

## 4. Выводы по работе

В ходе выполнения лабораторной работы была реализована и протестирована простейшая система трекинга плоского прямоугольного объекта на видео на основе ключевых точек и гомографии. Было разработано два варианта алгоритма:

- базовый режим `simple`, реализующий прямое сопоставление SIFT-признаков между шаблонным изображением объекта (первый кадр) и каждым последующим кадром, с последующей оценкой гомографии и отрисовкой рамки вокруг объекта;
- улучшенный режим `flow`, комбинирующий SIFT + Homography для инициализации и переинициализации с оптическим потоком Лукаса–Канаде для отслеживания уже найденных точек между соседними кадрами.

Результаты показали, что:

- использование ключевых точек (SIFT) и гомографии позволяет точно восстанавливать положение плоского объекта (обложки книги) в кадре и строить рамку, отражающую перспективные искажения;
- качество трекинга зависит от текстурированности объекта и качества видео; при малом числе ключевых точек и сильном уменьшении объекта трекинг становится менее устойчивым;
- добавление оптического потока позволяет уменьшить вычислительную нагрузку и сделать движение рамки более плавным, при этом требует механизма реинициализации для восстановления трекинга после неудачных шагов.


## 5. Использованные источники

1. OpenCV: SIFT — детектирование и описание локальных признаков  
   https://docs.opencv.org/4.x/da/df5/tutorial_py_sift_intro.html

2. OpenCV: Feature Matching (BFMatcher, KNN, Lowe ratio test)  
   https://docs.opencv.org/4.x/dc/dc3/tutorial_py_matcher.html

3. OpenCV: Feature Matching + Homography to find Objects  
   https://docs.opencv.org/4.x/d1/de0/tutorial_py_feature_homography.html

4. OpenCV: Optical Flow (Lucas–Kanade, calcOpticalFlowPyrLK)  
   https://docs.opencv.org/4.x/d4/dee/tutorial_optical_flow.html
