# ЛР2: Трекинг объекта на видео на основе ключевых точек

## 1. Теоретическая база

В данной работе рассматривается задача трекинга плоского объекта на видео по его крупному изображению в первом кадре. Основой подхода является использование **ключевых точек** и их дескрипторов, а также оценка **гомографии** между шаблонным изображением объекта и текущими кадрами видео.

Ключевые точки (feature points) — это характерные точки изображения (углы, контрастные текстурные элементы), которые можно устойчиво находить при изменениях масштаба, поворота и освещения. Для описания окрестности точки используются дескрипторы (вектор признаков). В работе применяется алгоритм **SIFT** (Scale-Invariant Feature Transform), обеспечивающий устойчивость к изменению масштаба и поворота объекта.

Для сопоставления ключевых точек между первым кадром (шаблоном объекта) и текущим кадром используется сопоставление дескрипторов: в простом варианте — полный перебор (Brute-Force) с нормой L2 и `crossCheck=True`, в улучшенном — KNN-сопоставление с применением критерия Lowe ratio для отбора наиболее надёжных соответствий. По найденным соответствиям оценивается матрица **гомографии**, задающая перспективное преобразование плоскости объекта из координат первого кадра в координаты текущего кадра. Применяя гомографию к прямоугольнику, соответствующему границам объекта в первом кадре, можно восстановить положение и ориентацию объекта на каждом последующем кадре.

В улучшенном варианте используется также классический метод **оптического потока Лукаса–Канаде (Lucas–Kanade optical flow)**. Оптический поток позволяет отслеживать уже найденные точки между соседними кадрами, опираясь на предположение о малых смещениях и локальной постоянстве яркости. Это снижает вычислительную нагрузку, так как нет необходимости на каждом кадре полностью переоткрывать и сопоставлять все ключевые точки на изображении.

## 2. Описание разработанной системы

Реализовано 2 скрипта на Python с использованием библиотеки OpenCV, поддерживающий два режима работы:

- `simple_version.py` — простой трекинг объекта по ключевым точкам SIFT и гомографии;
- `smart_version.py` — улучшенный трекинг, совмещающий SIFT + гомографию с оптическим потоком Лукаса–Канаде и периодической реинициализацией.

### 2.1. Общая архитектура

Основные этапы работы программы:

1. Чтение входного видео и извлечение первого кадра. Предполагается, что на первом кадре объект занимает значительную часть кадра и показан крупным планом.
2. Инициализация детектора признаков SIFT и общих вспомогательных функций:
   - `get_keypoints_descriptors(img)` — поиск ключевых точек и дескрипторов SIFT на изображении;
   - `match_keypoints_simple(desc1, desc2)` — сопоставление дескрипторов методом Brute-Force с нормой L2 и `crossCheck=True` (для простого режима);
   - `match_keypoints_ratio(desc1, desc2, ratio)` — сопоставление дескрипторов методом KNN с применением Lowe ratio test (для режима с оптическим потоком);
   - `find_homography(kp1, kp2, matches, ransac_thresh, min_inliers)` — вычисление матрицы гомографии по соответствиям ключевых точек с использованием RANSAC и опциональной проверкой минимального числа inliers;
   - `get_box_corners(shape)` — формирование списка из четырёх углов прямоугольника, соответствующего границам объекта на шаблонном кадре;
   - `warp_box(corners, H)` — применение гомографии к углам прямоугольника;
   - `draw_box(frame, corners)` — отрисовка зелёной рамки по четырём углам и подписи `"Object"` на текущем кадре.
3. В зависимости от значения параметра `MODE` вызывается один из режимов:
   - `run_simple_tracking()` — простой режим;
   - `run_flow_tracking()` — режим с оптическим потоком.

Запись результата производится в выходной видеофайл (`output_tracked_simple.mp4` или `output_tracked_flow.mp4`), а часть кадров периодически отображается для визуального контроля.

### 2.2. Режим `simple` (SIFT + Homography)

В режиме `simple` трекинг реализован по следующему алгоритму:

1. По первому кадру (шаблону) вычисляются ключевые точки и дескрипторы SIFT. Этот кадр рассматривается как “изображение объекта”, положение которого нужно отслеживать.
2. Для каждого последующего кадра:
   - вычисляются ключевые точки и дескрипторы SIFT;
   - выполняется сопоставление дескрипторов текущего кадра с дескрипторами шаблона при помощи Brute-Force matcher с нормой L2 и `crossCheck=True`;
   - лучшие совпадения сортируются по расстоянию дескрипторов и из их подмножества оценивается матрица гомографии;
   - прямоугольник, соответствующий границам объекта в первом кадре, переносится в координаты текущего кадра посредством гомографии;
   - поверх кадра рисуется рамка, максимально соответствующая положению и ориентации объекта, а также подпись `"Object"`.


### 2.3. Режим `flow` (SIFT + Homography + Optical Flow)

В режиме `flow` реализован более производительный и устойчивый трекинг за счёт использования оптического потока между соседними кадрами и периодической реинициализации по признакам.

Алгоритм:

1. **Инициализация по первому кадру:**
   - первый кадр переводится в градации серого;
   - для первого кадра вычисляются SIFT-признаки (ключевые точки и дескрипторы);
   - на первом же кадре (как на “текущем”) выполняется сопоставление дескрипторов с шаблоном с помощью KNN и Lowe ratio test;
   - по отобранным соответствиям оценивается гомография, восстанавливается положение прямоугольника, окружающего объект;
   - внутри этого прямоугольника выбирается набор “хороших” углов при помощи `goodFeaturesToTrack` — это начальные точки для расчёта оптического потока.
2. **Отслеживание по оптическому потоку:**
   - для каждой пары соседних кадров используется `calcOpticalFlowPyrLK`, который вычисляет новые координаты ранее выбранных точек в следующем кадре;
   - по соответствиям “старые точки — новые точки” оценивается гомография между предыдущим и текущим кадром;
   - предыдущий прямоугольник вокруг объекта переносится на текущий кадр, что позволяет обновить положение рамки без повторного глобального поиска по ключевым точкам;
   - если число корректно отследенных точек мало или гомография нестабильна, считается, что трекинг по потоку потерян.
3. **Реинициализация:**
   - если оптический поток не даёт достаточного числа надёжных точек или гомографию построить не удаётся, запускается процедура реинициализации:
     - снова используется поиск ключевых точек SIFT и сопоставление с шаблоном;
     - по гомографии заново восстанавливается рамка вокруг объекта;
     - внутри рамки заново выбираются точки для оптического потока.

Таким образом, режим `flow` сочетает в себе надёжность поиска по ключевым точкам и гомографии с быстротой обновления положения объекта по оптическому потоку между кадрами.

## 3. Результаты работы и тестирования системы

Алгоритм был протестирован в двух режимах:

1. **На трёх тестовых видеороликах**.
2. **На собственном видео**, где объектом является книга. В первом кадре обложка книги показана крупным планом, далее камера постепенно отдаляется и изменяет ракурс.

Наблюдения:

- В режиме `simple`:
  - при хорошем освещении и достаточном размере объекта рамка устойчиво следует за книгой;
  - при сильном отдалении и уменьшении объекта число совпадений между шаблоном и текущим кадром уменьшается, гомография становится менее надёжной, из-за чего рамка иногда исчезает или начинает колебаться;
- В режиме `flow`:
  - при плавном движении камеры по отношению к книге рамка обновляется более плавно, так как между кадрами используются смещения точек оптического потока, а не полный пересчёт признаков;
  - при кратковременных потерях устойчивости оптического потока (например, при резком движении) срабатывает механизм реинициализации, и рамка вновь “прилипает” к объекту после стабилизации кадра;

## 4. Выводы по работе

В ходе выполнения лабораторной работы была реализована и протестирована простейшая система трекинга плоского прямоугольного объекта на видео на основе ключевых точек и гомографии. Было разработано два варианта алгоритма:

- базовый режим `simple`, реализующий прямое сопоставление SIFT-признаков между шаблонным изображением объекта (первый кадр) и каждым последующим кадром, с последующей оценкой гомографии и отрисовкой рамки вокруг объекта;
- улучшенный режим `flow`, комбинирующий SIFT + Homography для инициализации и переинициализации с оптическим потоком Лукаса–Канаде для отслеживания уже найденных точек между соседними кадрами.

Результаты показали, что:

- использование ключевых точек (SIFT) и гомографии позволяет точно восстанавливать положение плоского объекта (обложки книги) в кадре и строить рамку, отражающую перспективные искажения;
- качество трекинга зависит от текстурированности объекта и качества видео; при малом числе ключевых точек и сильном уменьшении объекта трекинг становится менее устойчивым;
- добавление оптического потока позволяет уменьшить вычислительную нагрузку и сделать движение рамки более плавным, при этом требует механизма реинициализации для восстановления трекинга после неудачных шагов.


## 5. Использованные источники

1. OpenCV: SIFT — детектирование и описание локальных признаков  
   https://docs.opencv.org/4.x/da/df5/tutorial_py_sift_intro.html

2. OpenCV: Feature Matching (BFMatcher, KNN, Lowe ratio test)  
   https://docs.opencv.org/4.x/dc/dc3/tutorial_py_matcher.html

3. OpenCV: Feature Matching + Homography to find Objects  
   https://docs.opencv.org/4.x/d1/de0/tutorial_py_feature_homography.html

4. OpenCV: Optical Flow (Lucas–Kanade, calcOpticalFlowPyrLK)  
   https://docs.opencv.org/4.x/d4/dee/tutorial_optical_flow.html
